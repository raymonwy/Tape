<!DOCTYPE html>
<html>
    <head>

    </head>

    <body>
        
        <canvas id = "board" width="500 " height ="500" style ="border:1px solid black;" ></canvas>
        <script>
            var board = document.getElementById("board").getContext("2d");
            board.font = "40px Times New Roman";
            var width = 500;
            var height = 500;
            var enemyList = {};
            var upgradeList = {};
            var bulletList = {};
            var aoe_upgrade_distance = 200;
            var heal_amount = 5;
            var player_atk_spd = 20;
            var iframe = 0;
            var frame_count = 0;
            var player;
            var enemy_atk_spd = 50;


            function object(new_tpye,new_x,new_y,new_spdx,new_spdy,new_width,new_height,new_color){
                var self ={
                    type:new_tpye,
                    x:new_x, 
                    y:new_y,
                    spdx:new_spdx,
                    spdy:new_spdy,
                    height:new_height,
                    width:new_width,
                    color:new_color,
                    drawObject: function(){
                        board.save();
                        board.fillStyle = self.color;
                        board.fillRect(self.x-self.width/2,self.y-self.height/2,self.width,self.height);
                        board.restore();
                    },
                    updateObject: function(){

                        if(self.type == "player"){
                            playerMove();
                        }
                        else{

                            self.x+=self.spdx;
                            self.y+=self.spdy;
                        
                            if(self.type != "bullet" && self.type != "upgrade"){
                                if(self.x - self.width/2 < 0 || self.x + self.width/2 > width){
                                    self.spdx = -self.spdx;
                                }
                                if(self.y - self.height/2 < 0 || self.y + self.height/2 > height){
                                    self.spdy = -self.spdy;
                                }
                                self.atk_counter++;
                                self.atk_angle = Math.atan2(player.y-self.y,player.x-self.x)/ Math.PI *180;
                                
                                self.attack_action();
                            }
                        }
                    },
                    update:function(){
                        self.drawObject();
                        self.updateObject();
                    },
                }

                return self;
            }


            function CreatePlayer(){
                var self = object("player",60,70,30,16,20,20,"green");
                self.iframe_seconds = 1.5;
                self.atk_color = "green";
                self.effect=" ";
                self.color="green";
            
                self.atk_spd = player_atk_spd;
                self.atk_counter = 0;
                self.hp = 10;
                self.down_button = false;
                self.left_button = false;
                self.up_button = false;
                self.right_button = false;
                self.atk_angle = 0;
                self.attack_action = function(){
                    if(self.atk_counter >= self.atk_spd )
                        {
                        rand_bullet(self.atk_angle,self);
                        self.atk_counter = 0;
                        }
                };
                player = self;
            }
           
            function enemy(new_id, new_x, new_y, new_spdx, new_spdy, new_height, new_width,new_color ){
                var self = object("enemy",new_x,new_y,new_spdx,new_spdy,new_height,new_width,new_color);
                
                self.atk_color = new_color;
                self.atk_spd = enemy_atk_spd;
                self.atk_counter = 0;
                self.attack_action = function(){
                    if(self.atk_counter >= self.atk_spd )
                        {
                        rand_bullet(self.atk_angle,self);
                        self.atk_counter = 0;
                        }
                };
                
                self.atk_angle = 0;
                enemyList[new_id] = self;
            }
            

            function rand_enemy(){
                var unit_height = 15 + Math.random() * 15;
                var unit_width = 15 + Math.random() * 15;
                enemy(Math.random(),Math.random()*(width - unit_width/2),Math.random()*(height - unit_height/2), 5 + Math.random()* 5,5 + Math.random()* 5, unit_height, unit_width , "red");
            } 

            function bullet(new_id, new_x, new_y, new_spdx, new_spdy, new_height, new_width,unit ){
                var self = object("bullet",new_x,new_y,new_spdx,new_spdy,new_height,new_width,unit.color);
        
                self.color= unit.color;
                self.atker = unit.type;
                bulletList[new_id] = self; 
                
            }
            
            
            function rand_bullet(angle,unit){
                
                bullet(Math.random(),unit.x,unit.y, Math.cos(angle/180*Math.PI) * 6,Math.sin(angle/180*Math.PI)*6, 10,  10, unit);
            } 


            function upgrade(new_id, new_x, new_y, new_spdx, new_spdy, new_height, new_width,new_color,effect ){
                var self  = object  ("upgrade", new_x, new_y, new_spdx, new_spdy, new_height, new_width,new_color)
                self.effect = "";
                
                upgradeList[new_id] = self;
            }

            function heal_upgrade(){
                player.hp += heal_amount;
            }

            function atk_spd_upgrade(){
                player.atk_spd -= 2.5;
            }

            function rand_upgrade(){
                upgrade(Math.random(),Math.random()*width,Math.random()*height, 0, 0, 10, 10, "orange",atk_spd_upgrade);
            } 

            function aoe_upgrade_effect(){
                var aoe ={
                    x:player.x,
                    y:player.y,
                    height:aoe_upgrade_distance,
                    width:aoe_upgrade_distance,
                };
                for(var key in enemyList)
                {
                    if(Collision(enemyList[key], aoe))
                    {
                        delete enemyList[key];
                    }
                }
            }

            function aoe_upgrade(){
                upgrade(Math.random(),Math.random()*width,Math.random()*height, 0, 0, 10, 10, "purple",aoe_upgrade_effect);
            }

          
            
            function Collision(one, two){
                // collision for points
                /*
                if(one != two){
                    var x = one.x - two.x;
                    var y = one.y - two.y;
                    return Math.sqrt(x*x+y*y) < collision_distance;
                }
                */

                // collision for rectangle
                var one_x = one.x - one.width/2;
                var one_y = one.y - one.height/2;
                var two_x = two.x - two.width/2;
                var two_y = two.y - two.height/2;
                return one_x <= two_x + two.width && two_x <= one_x + one.width && one_y <= two_y + two.height && two_y <= one_y + one.height;
            }

            document.onmousemove = function(mouse){
            
                var pos_x = mouse.clientX - document.getElementById('board').getBoundingClientRect().left;
                var pos_y = mouse.clientY -  document.getElementById('board').getBoundingClientRect().top;
                
                pos_x -= player.x;
                pos_y -= player.y;
                player.atk_angle = Math.atan2(pos_y,pos_x)/ Math.PI *180;
            }

         document.onclick = function(mouse){
                attack_action(player);
            
           }
           
           document.oncontextmenu = function(mouse){
            if(player.atk_counter > player.atk_spd*2)
            {

                rand_bullet(player.atk_angle -5,player);
                rand_bullet(player.atk_angle,player);
                rand_bullet(player.atk_angle +5,player);
                player.atk_counter = 0;
            }
            mouse.preventDefault();
        }             

           document.onkeydown = function(event){
               if(event.keyCode == 68)
                    player.right_button = true;
               else if(event.keyCode == 83)
                    player.down_button = true;
               else if (event.keyCode == 65)
                    player.left_button = true;
                else if(event.keyCode == 87)
                    player.up_button = true; 
           } 

           document.onkeyup = function(event){
                if(event.keyCode == 68)
                    player.right_button = false;
               else if(event.keyCode == 83)
                    player.down_button = false;
               else if (event.keyCode == 65)
                    player.left_button = false;
                else if(event.keyCode == 87)
                    player.up_button = false;      
           }

        function attack_action(unit){
            if(unit.atk_counter >= unit.atk_spd )
               {
                   rand_bullet(unit.atk_angle,unit);
                   unit.atk_counter = 0;
               }
        }

        function player_hit(unit){
            var x = 0;
            if(iframe == 0){
                if(Collision(player,unit)){
                    
                            player.hp -= 1;
                            iframe = Math.floor(new Date().getTime()/1000) % 100000;
                            x = 1;
                        }
                    }
                    else if( Math.floor(new Date().getTime()/1000) % 100000 > iframe + player.iframe_seconds){
                        iframe = 0;
                    }

        return x;

        }
           function playerMove(){
                if(player.up_button)
                player.y  -= 7;
                if(player.down_button)
                player.y  +=7;
                if(player.left_button)
                player.x -= 7;
                if(player.right_button)
                player.x += 7;   

                if(player.x < player.width/2) {
                    player.x = player.width/2;
                }
                if(player.x > width - player.width/2){
                    player.x = width - player.width/2;
                }
                if(player.y< player.height/2)
                {
                    player.y =  player.height/2;
                }
                if( player.y > height- player.height/2){
                    player.y = height - player.height/2;
                }
                
           }
            function new_start(){
                enemyList = {};
                player.hp = 10;
                frame_count = 0;
                upgradeList= {};
                bulletList = {};
            }



            setInterval(update,30);
            CreatePlayer();
            function update(){
                frame_count++;
                if(frame_count % 100 == 0)
                {
                    rand_enemy();
                }
                if(frame_count % 600 == 0)
                {
                    rand_upgrade();
                }
                
                if(frame_count % 800 == 0)
                {
                    aoe_upgrade();
                    frame_count = 0;
                }

                board.clearRect(0,0,width,height);
                
                

                for( var key in enemyList){
                    enemyList[key].update();
                    player_hit(enemyList[key]);   
                }

                for( var key in bulletList){
                    bulletList[key].update();
                    if(bulletList[key].atker != "enemy"){
                         for(var lock in enemyList)
                        {
                            if(Collision(bulletList[key],enemyList[lock])){
                                delete enemyList[lock];
                                delete bulletList[key];
                                
                                break;
                            }
                        }
                    }
                    else if (bulletList[key].atker != "player"){
                        
                        if(player_hit(bulletList[key]))
                            delete bulletList[key];
                    }
                }

                for( var key in upgradeList){
                    
                    upgradeList[key].update();
                    if(Collision(player,upgradeList[key])){
                        player.effect = upgradeList[key].effect;
                        delete upgradeList[key];
                        player.effect();
                    }
                }

                if(player.hp <= 0){
                    new_start();
                }
                player.update();
                player.atk_counter++;
                board.fillText(player.hp, 0 , 30);
               
            }
        </script>

    </body>

</html>