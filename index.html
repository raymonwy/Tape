<!DOCTYPE html>
<html>
    <head>

    </head>

    <body>
        
        <canvas id = "board" width="500 " height ="500" style ="border:1px solid black;" ></canvas>
        <script>
            var board = document.getElementById("board").getContext("2d");
            board.font = "40px Times New Roman";
            var width = 500;
            var height = 500;
            var enemyList = {};
            var upgradeList = {};
            var aoe_upgrade_distance = 200;
            var heal_amount = 5;
                var player ={
                text:"Y",
                x:60,
                spdx:30,
                spdy:16,
                y:70,
                hp:10,
                height:20,
                width:20,
                correction:20,
                iframe_seconds:1.5,
                color:"green",
                
                };
           
            function enemy(new_id, new_x, new_y, new_spdx, new_spdy, new_height, new_width,new_color ){
                var player2 ={
                x:new_x,
                spdx:new_spdx,
                spdy:new_spdy,
                y:new_y,
                id:new_id,
                height:new_height,
                width:new_width,
                color:new_color,
                };
                enemyList[new_id] = player2;
            }

            function rand_enemy(){
                enemy(Math.random(),Math.random()*width,Math.random()*height, 5 + Math.random()* 5,5 + Math.random()* 5, 15 + Math.random() * 15,  15 + Math.random() * 15, "red");
            } 

            function upgrade(new_id, new_x, new_y, new_spdx, new_spdy, new_height, new_width,new_color,effect ){
                var upgrade ={
                x:new_x,
                spdx:new_spdx,
                spdy:new_spdy,
                y:new_y,
                id:new_id,
                height:new_height,
                width:new_width,
                color:new_color,
                effect,
                };
                upgradeList[new_id] = upgrade;
            }

            function heal_upgrade(){
                player.hp += heal_amount;
            }
            function rand_upgrade(){
                upgrade(Math.random(),Math.random()*width,Math.random()*height, 0, 0, 10, 10, "orange",heal_upgrade);
            } 

            function aoe_upgrade_effect(){
                var aoe ={
                    x:player.x,
                    y:player.y,
                    height:aoe_upgrade_distance,
                    width:aoe_upgrade_distance,
                }
                for(var key in enemyList)
                {
                    if(Collision(enemyList[key], aoe))
                    {
                        delete enemyList[key];
                    }
                }
            }

            function aoe_upgrade(){
                upgrade(Math.random(),Math.random()*width,Math.random()*height, 0, 0, 10, 10, "purple",aoe_upgrade_effect);
            }

            function drawPlayer(unit){
                board.save();
                board.fillStyle = unit.color;
                board.fillRect(unit.x-unit.width/2,unit.y-unit.height/2,unit.width,unit.height);
                board.restore();
            }

            function drawEnemy(unit){
                board.save();
                board.fillStyle = unit.color;
                board.fillRect(unit.x-unit.width/2,unit.y-unit.height/2,unit.width,unit.height);
                board.restore();
            }

            function updatePlayer(unit){
                    unit.x+=unit.spdx;
                unit.y+=unit.spdy;
                if(unit.x < 0 || unit.x > width){
                    unit.spdx = -unit.spdx;
                }
                if(unit.y < 0 || unit.y > height){
                    unit.spdy = -unit.spdy;
                }
            }

            function playerMove(unit){
                drawEnemy(unit);
                updatePlayer(unit);
            }
            
            function Collision(one, two){
                // collision for points
                /*
                if(one != two){
                    var x = one.x - two.x;
                    var y = one.y - two.y;
                    return Math.sqrt(x*x+y*y) < collision_distance;
                }
                */

                // collision for rectangle
                var one_x = one.x - one.width/2;
                var one_y = one.y - one.height/2;
                var two_x = two.x - two.width/2;
                var two_y = two.y - two.height/2;
                return one_x <= two_x + two.width && two_x <= one_x + one.width && one_y <= two_y + two.height && two_y <= one_y + one.height;
            }

            document.onmousemove = function(mouse){
            
                var pos_x = mouse.clientX - document.getElementById('board').getBoundingClientRect().left;
                var pos_y = mouse.clientY -  document.getElementById('board').getBoundingClientRect().top;

                if(pos_x < player.width/2) {
                    pos_x = 0 + player.width/2;
                }
                if(pos_x > width - player.width/2){
                    pos_x = width - player.width/2;
                }
                if(pos_y< player.height/2)
                {
                    pos_y = 0 + player.height/2;
                }
                if( pos_y > height- player.height/2){
                    pos_y = height - player.height/2;
                }
                player.y = pos_y;
                player.x = pos_x;

            }

           
            
            function new_start(){
                enemyList = {};
                player.hp = 10;
                frame_count = 0;
                upgradeList= {};
            }

            setInterval(update,40);
            var iframe = 0;
            var frame_count = 0;
            function update(){
                frame_count++;
                if(frame_count % 100 == 0)
                {
                    rand_enemy();
                }
                if(frame_count % 100 == 0)
                {
                    rand_upgrade();
                }
                
                if(frame_count % 100 == 0)
                {
                    aoe_upgrade();
                    frame_count = 0;
                }

                board.clearRect(0,0,width,height);
                for( var key in enemyList){
                    
                    playerMove(enemyList[key]);
                    if(iframe == 0){
                        if(Collision(player,enemyList[key])){
                    
                            player.hp -= 1;
                            iframe = Math.floor(new Date().getTime()/1000) % 100000;
                           
                        }
                    }
                    else if( Math.floor(new Date().getTime()/1000) % 100000 > iframe + player.iframe_seconds){
                        iframe = 0;
                    }
                        
                    
                } 
                
                for( var key in upgradeList){
                    
                    playerMove(upgradeList[key]);
                    if(Collision(player,upgradeList[key])){
                        player.effect = upgradeList[key].effect;
                        delete upgradeList[key];
                        player.effect();
                        
                       

                    }
                }

                if(player.hp <= 0){
                    new_start();
                }
                drawPlayer(player);
                board.fillText(player.hp, 0 , 30);
                board.fillText(Math.floor(new Date().getTime()/1000) % 100000 , 300 , 30);
                board.fillText(iframe , 0 , 100);
            }
        </script>

    </body>

</html>